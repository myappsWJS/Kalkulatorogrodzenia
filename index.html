<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Kalkulator ogrodzeń z siatki</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #ccc; 
    padding: 20px; 
    text-align: center;
  }
  .container {
    width: 800px;
    margin: auto;
    display: none; /* ukryte do czasu logowania */
  }
  h2 { 
    background: limegreen; 
    color: black; 
    padding: 10px; 
    text-align: center;
    box-sizing: border-box;
    margin: 0 auto 15px auto;
  }
  table { 
    border-collapse: collapse; 
    margin: 10px auto; 
    width: 100%; 
  }
  td, th { 
    border: 1px solid #000; 
    padding: 5px; 
    text-align: center; 
  }
  .label-cell { 
    background: #aaa; 
    text-align: left; 
    padding-left: 10px; 
    font-weight: bold;
  }
  .input-cell { 
    background: yellow; 
    text-align: center; 
  }
  .input-cell input, .input-cell select {
    width: 100%;
    box-sizing: border-box;
    padding: 4px;
    font-size: 14px;
    text-align: center;
  }
  .header-row {
    background: cyan; 
    font-weight: bold; 
  }
  .result-row td {
    background: #00e5ff; 
  }
  .sum-row td {
    background: #ffeb3b;
    font-weight: bold;
  }
  button { margin-top: 10px; padding: 8px 14px; font-size: 14px; cursor: pointer; }
  #wyniki { display: none; } /* ukrywamy do czasu wyboru wysokości i koloru */
  #login-box {
    margin: 100px auto;
    background: #fff;
    padding: 30px;
    width: 300px;
    border-radius: 12px;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
  }
</style>
</head>
<body>

<!-- ekran logowania -->
<div id="login-box">
  <h2>Logowanie</h2>
  <input type="password" id="login-pass" placeholder="Wpisz kod dostępu">
  <br><br>
  <button id="login-btn">Zaloguj</button>
  <p id="login-msg" style="color:red; display:none;">Błędny kod!</p>
</div>

<!-- główna aplikacja -->
<div class="container">
  <h2>Kalkulator ogrodzeń z siatki</h2>

  <table>
    <tr>
      <td class="label-cell">Długość całkowita ogrodzenia (m)</td>
      <td class="input-cell" colspan="3"><input type="number" id="dlugosc" value="0" min="0" step="0.1"></td>
    </tr>
    <tr>
      <td class="label-cell">Ilość narożników</td>
      <td class="input-cell" colspan="3">
        <select id="narozniki">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </td>
    </tr>
    <tr>
      <td class="label-cell">Wysokość ogrodzenia</td>
      <td class="input-cell" colspan="3">
        <select id="wysokosc">
          <option value="">Wybierz</option>
          <option value="1">1</option>
          <option value="1.2">1,2</option>
          <option value="1.5">1,5</option>
        </select>
      </td>
    </tr>
    <tr>
      <td class="label-cell">Kolor ogrodzenia</td>
      <td class="input-cell" colspan="3">
        <select id="kolor">
          <option value="">Wybierz</option>
          <option value="Ant">Antracyt</option>
          <option value="Zie">Zielony</option>
          <option value="Ocynk">Ocynk</option>
        </select>
      </td>
    </tr>
  </table>

  <table id="wyniki">
    <tr class="header-row">
      <th>Referencja</th>
      <th>Nazwa</th>
      <th>Cena</th>
      <th>Ilość</th>
      <th>Wartość</th>
    </tr>
    <tr class="result-row" data-nazwa="Siatka"><td class="ref"></td><td class="name">Siatka</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="SŁUPEK"><td class="ref"></td><td class="name">SŁUPEK 42X1,0MM</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="DRUT NACIĄGOWY"><td class="ref"></td><td class="name">DRUT NACIĄGOWY 50MB 2,4MM</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="DRUT WIĄZAŁKOWY"><td class="ref"></td><td class="name">DRUT WIĄZAŁKOWY 50MB 1,4MM</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="NAPINACZ"><td class="ref"></td><td class="name">NAPINACZ DO SIATKI</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="NASADKA"><td class="ref"></td><td class="name">NASADKA DO MONT PODPORY 42MM</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="PRZELOT"><td class="ref"></td><td class="name">12 SZT PRZELOT Z WKR DO SIATKI</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="OBEJMA"><td class="ref"></td><td class="name">OBEJMA KOŃCOWA DO SŁUPKA 42MM</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="ŚRUBA"><td class="ref"></td><td class="name">2SZT ŚRUBA MOCUJĄCA</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="result-row" data-nazwa="PRĘT"><td class="ref"></td><td class="name">PRĘT NAPINA STAL POWL 8MM</td><td class="price"></td><td class="qty">0</td><td class="value">0</td></tr>
    <tr class="sum-row"><td colspan="4">SUMA</td><td id="suma">0</td></tr>
  </table>

  <button id="btnCalc">Oblicz</button>
</div>

<script>
(function(){
  const loginBox = document.getElementById("login-box");
  const loginBtn = document.getElementById("login-btn");
  const loginPass = document.getElementById("login-pass");
  const loginMsg = document.getElementById("login-msg");
  const container = document.querySelector(".container");
  const wynikiTable = document.getElementById("wyniki");

  // --- prosty login ---
  loginBtn.addEventListener("click", () => {
    if (loginPass.value === "lm-10") {
      loginBox.style.display = "none";
      container.style.display = "block";
    } else {
      loginMsg.style.display = "block";
    }
  });

  // --- kalkulator ---
  const dl = document.getElementById('dlugosc');
  const nr = document.getElementById('narozniki');
  const wys = document.getElementById('wysokosc');
  const kol = document.getElementById('kolor');
  const btn = document.getElementById('btnCalc');
  const sumaCell = document.getElementById('suma');

  let produkty = [];

  const sheetId = "1ady3fw4DZBHYeJ0yumcUGCUcX4Qp1w2tA79n2-9DvJQ"; 
  const gidMap = { "1": "0", "1.2": "1288678779", "1.5": "1115203468" };

  function loadSheet(wysokosc, callback) {
    const gid = gidMap[wysokosc];
    if (!gid) { callback([]); return; }

    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=responseHandler:sheetCallback&gid=${gid}`;
    const script = document.createElement("script");

    window.sheetCallback = function(json) {
      try {
        const rows = json.table.rows.map(r => ({
          ref: r.c[0] ? r.c[0].v : "",
          nazwa: r.c[1] ? r.c[1].v : "",
          cena: r.c[4] ? parseFloat(r.c[4].v) : 0
        }));
        callback(rows);
      } catch(e) { console.error(e); callback([]); }
      finally { script.remove(); delete window.sheetCallback; }
    };

    script.src = url;
    document.body.appendChild(script);
  }

  function policzSume() {
    let suma = 0;
    document.querySelectorAll("#wyniki .result-row").forEach(row => {
      const price = parseFloat(row.querySelector(".price").textContent.replace(",","."));
      const qty = parseFloat(row.querySelector(".qty").textContent);
      let wartosc = 0;
      if (!isNaN(price) && !isNaN(qty)) wartosc = price * qty;
      row.querySelector(".value").textContent = wartosc.toFixed(2);
      suma += wartosc;
    });
    sumaCell.textContent = suma.toFixed(2);
  }

  function wyszukajProdukt(keyword, qty, kolor) {
    const znalezione = produkty.filter(p => 
      p.nazwa && p.nazwa.toUpperCase().includes(keyword.toUpperCase()) &&
      (!kolor || p.nazwa.toUpperCase().includes(kolor.toUpperCase()))
    );

    const row = document.querySelector(`tr[data-nazwa='${keyword}']`);
    const refCell = row.querySelector(".ref");
    const nameCell = row.querySelector(".name");
    const priceCell = row.querySelector(".price");
    const qtyCell = row.querySelector(".qty");

    qtyCell.textContent = qty;

    if (znalezione.length === 0) {
      refCell.textContent = "";
      nameCell.textContent = keyword + " (brak w ofercie)";
      priceCell.textContent = "";
    } else if (znalezione.length === 1) {
      refCell.textContent = znalezione[0].ref;
      nameCell.textContent = znalezione[0].nazwa;
      priceCell.textContent = znalezione[0].cena.toFixed(2);
    } else {
      refCell.textContent = "";
      priceCell.textContent = "";

      const select = document.createElement("select");
      select.innerHTML = `<option value="">Wybierz rodzaj</option>` +
        znalezione.map(z => 
          `<option value="${z.ref}" data-cena="${z.cena}">${z.nazwa} — ${z.cena.toFixed(2)}</option>`
        ).join("");

      select.addEventListener("change", (e) => {
        const opt = e.target.selectedOptions[0];
        refCell.textContent = opt.value;
        priceCell.textContent = parseFloat(opt.dataset.cena).toFixed(2);
        policzSume();
      });

      nameCell.innerHTML = "";
      nameCell.appendChild(select);
    }
  }

  function isBad(v){ return v === "brak danych" || v === null; }
  function fmt(v){
    if (v === "brak danych" || v === null) return "brak danych";
    if (typeof v === 'number'){
      if (Number.isInteger(v)) return String(v);
      return String(Math.round(v * 100) / 100);
    }
    return String(v);
  }

  function oblicz(){
    const wysokosc = wys.value;
    const kolor = kol.value;

    // tabela pokazuje się dopiero jak oba pola są wybrane
    if (wysokosc && kolor) {
      wynikiTable.style.display = "table";
    } else {
      wynikiTable.style.display = "none";
      return;
    }

    const B4 = parseFloat(dl.value) || 0;
    const B5 = parseInt(nr.value) || 0;

    let D4;
    if (B4 <= 25) D4 = 2;
    else if (B4 <= 50) D4 = 4;
    else if (B4 <= 75) D4 = 6;
    else if (B4 <= 100) D4 = 8;
    else D4 = "brak danych";

    let D9 = B4 * 3;
    let E9 = (B4 * 5) / 10;

    let F4;
    if (B4 <= 25) F4 = 0;
    else if (B4 <= 50) F4 = 1;
    else if (B4 <= 75) F4 = 2;
    else if (B4 <= 100) F4 = 3;
    else F4 = "brak danych";

    let E6 = isBad(F4) ? "brak danych" : (B5 + F4);
    let F6 = isBad(D4) ? "brak danych" : (B5 * 2) + D4;
    let G4 = Math.ceil(B4 / 2.5) + 1;
    let H4 = isBad(F4) ? "brak danych" : 6 + (F4 * 6);
    let G6 = isBad(H4) ? "brak danych" : (B5 * 6) + H4;
    let H6 = (isBad(E6) || isBad(G4)) ? "brak danych" : (G4 - E6 - 2);
    let H7 = isBad(H6) ? "brak danych" : (H6 * 3);

    let B8 = (isBad(G4) || isBad(F6)) ? "brak danych" : (G4 + F6);
    let B9 = Math.max(1, Math.ceil(D9 / 50));
    let B10 = (E9 <= 50) ? 1 : 2;
    let B11 = G6;
    let B12 = F6;
    let B13 = isBad(H7) ? "brak danych" : Math.ceil(H7 / 12);
    let B14 = (isBad(B12) || isBad(B11)) ? "brak danych" : (B12 + B11);
    let B15 = isBad(B11) ? "brak danych" : Math.ceil(B11 / 2);
    let B16 = B12;
    let Siatka = Math.ceil(B4 / 10);

    loadSheet(wysokosc, rows => {
      produkty = rows;
      wyszukajProdukt("Siatka", fmt(Siatka), kolor);
      wyszukajProdukt("SŁUPEK", fmt(B8), kolor);
      wyszukajProdukt("DRUT NACIĄGOWY", fmt(B9), kolor);
      wyszukajProdukt("DRUT WIĄZAŁKOWY", fmt(B10), kolor);
      wyszukajProdukt("NAPINACZ", fmt(B11), kolor);
      wyszukajProdukt("NASADKA", fmt(B12), kolor);
      wyszukajProdukt("PRZELOT", fmt(B13), kolor);
      wyszukajProdukt("OBEJMA", fmt(B14), kolor);
      wyszukajProdukt("ŚRUBA", fmt(B15), kolor);
      wyszukajProdukt("PRĘT", fmt(B16), kolor);
      policzSume();
    });
  }

  btn.addEventListener('click', oblicz);
  dl.addEventListener('input', oblicz);
  nr.addEventListener('change', oblicz);
  wys.addEventListener('change', oblicz);
  kol.addEventListener('change', oblicz);

})();
</script>

</body>

</html>
